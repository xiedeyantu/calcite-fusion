name: Resolve JIRA on merged PR

on:
  pull_request:
    types: [closed]

permissions:
  contents: read

jobs:
  transition-jira:
    name: Transition Jira when PR merged
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true
    env:
      JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
      JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
    steps:
      - name: Extract first CALCITE key from PR title
        id: extract
        run: |
          PR_TITLE='${{ github.event.pull_request.title }}'
          KEY=$(echo "$PR_TITLE" | grep -oE 'CALCITE-[0-9]+' | head -n1 || true)
          echo "extracted_key=$KEY" >> $GITHUB_OUTPUT

      - name: Transition Jira issue (id=5, resolution=Fixed)
        if: steps.extract.outputs.extracted_key != ''
        run: |
          set -euo pipefail
          KEY="${{ steps.extract.outputs.extracted_key }}"
          echo "Will transition JIRA issue: $KEY"
          PR_NUM='${{ github.event.pull_request.number }}'
          PR_URL='${{ github.event.pull_request.html_url }}'
          
          PAYLOAD=$(jq -n \
            --arg id "5" \
            --arg res "Fixed" \
            --arg prnum "$PR_NUM" \
            --arg prurl "$PR_URL" \
            '{
              transition: { id: $id },
              fields: { resolution: { name: $res } },
              update: { comment: [ { add: { body: ("Resolved via PR #" + $prnum + ": " + $prurl) } } ] }
            }')
          POST_URL="${JIRA_BASE_URL}/rest/api/2/issue/${KEY}/transitions"
          echo "POST $POST_URL"
          HTTP_CODE=$(curl -s -o /tmp/jresp -w "%{http_code}" -H "Authorization: Bearer ${JIRA_API_TOKEN}" -H "Content-Type: application/json" -X POST -d "$PAYLOAD" "$POST_URL")
          BODY=$(cat /tmp/jresp || true)
          echo "HTTP code: $HTTP_CODE"
          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "Successfully transitioned $KEY"
          else
            echo "Failed to transition $KEY. HTTP $HTTP_CODE"
            echo "Response body:"
            echo "$BODY"
            exit 1
          fi

      - name: Skip (no CALCITE key)
        if: steps.extract.outputs.extracted_key == ''
        run: echo "PR title contains no CALCITE-<num>; nothing to do."
