name: Resolve JIRA on merged PR

on:
  pull_request:
    types: [closed]

permissions:
  contents: read

jobs:
  resolve-jira:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (for safety)
        uses: actions/checkout@v4

      - name: Extract JIRA key from PR title or branch
        id: extract
        env:
          PR_TITLE: "${{ github.event.pull_request.title }}"
          PR_BRANCH: "${{ github.head_ref }}"
        run: |
          echo "PR_TITLE='$PR_TITLE'"
          echo "PR_BRANCH='$PR_BRANCH'"

          KEY=""
          if [[ $PR_TITLE =~ ([A-Z][A-Z0-9]+-[0-9]+) ]]; then
            KEY="${BASH_REMATCH[1]}"
          elif [[ $PR_BRANCH =~ ([A-Z][A-Z0-9]+-[0-9]+) ]]; then
            KEY="${BASH_REMATCH[1]}"
          fi

          echo "found=$KEY" >> $GITHUB_OUTPUT

      - name: No JIRA key found â€” skip
        if: steps.extract.outputs.found == ''
        run: |
          echo "No JIRA issue key detected in PR title or branch."
          echo "PR title: ${{ github.event.pull_request.title }}"
          echo "Branch: ${{ github.event.pull_request.head.ref }}"
          exit 0

      - name: Debug try GET issue
        if: steps.extract.outputs.found != ''
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
        run: |
          ISSUE=${{ steps.extract.outputs.found }}
          echo "Curl GET issue for debugging: $ISSUE"

          curl -i -s -u "${JIRA_USER_EMAIL}:${JIRA_API_TOKEN}" \
            -H "Accept: application/json" \
            "${JIRA_BASE_URL%/}/rest/api/2/issue/${ISSUE}" || true

      - name: List transitions (curl -> transitions.json)
        if: steps.extract.outputs.found != ''
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
        run: |
          ISSUE=${{ steps.extract.outputs.found }}
          echo "Listing transitions for $ISSUE"

          curl -s -u "${JIRA_USER_EMAIL}:${JIRA_API_TOKEN}" \
            -H "Accept: application/json" \
            "${JIRA_BASE_URL%/}/rest/api/2/issue/${ISSUE}/transitions?expand=transitions.fields" \
            -o transitions.json || true
          echo "---- transitions.json ----"
          jq . transitions.json || cat transitions.json || true
          echo "---- end transitions ----"

      - name: Transition using found transition id (curl, best-effort)
        if: steps.extract.outputs.found != ''
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
        run: |
          ISSUE=${{ steps.extract.outputs.found }}
          echo "Attempting automatic transition for $ISSUE"

          #TID=$(jq -r '.transitions[] | select(.name=="Resolved") | .id' transitions.json | head -n1 || true)

          if [ -z "$TID" ]; then
            TID=$(jq -r '.transitions[0].id' transitions.json 2>/dev/null || true)
            TNAME=$(jq -r '.transitions[0].name' transitions.json 2>/dev/null || true)
          fi

          if [ -z "$TID" ]; then
            echo "No transition id parsed. Inspect transitions.json above and set the desired transition id manually."
            exit 1
          fi

          echo "Using transition id=$TID (name='$TNAME')"

          HTTP_OUT=$(mktemp)
          curl -s -w "%{http_code}" -u "${JIRA_USER_EMAIL}:${JIRA_API_TOKEN}" \
            -H "Content-Type: application/json" \
            -X POST \
            --data "{\"transition\":{\"id\":\"${TID}\"}}" \
            "${JIRA_BASE_URL%/}/rest/api/2/issue/${ISSUE}/transitions" -o "${HTTP_OUT}" -S || true
          STATUS=$(tail -n1 "${HTTP_OUT}")
          echo "Response body:"
          cat "${HTTP_OUT}"
          echo ""
          echo "HTTP_status (curl): ${STATUS}"
          if [ "${STATUS}" = "204" ] || [ "${STATUS}" = "200" ]; then
            echo "Transition request succeeded (HTTP ${STATUS})."
          else
            echo "Transition request might have failed. Check the response above. Common causes: auth failure (401), permission denied (403), or invalid transition id (400)."
            exit 1
          fi
